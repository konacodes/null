-- nullc/tests/parser_test.null
-- Basic tests for parser functionality (tests underlying operations)

@use "std/io.null"
@use "std/mem.null"
@use "std/string.null"

-- Test memory allocation (used by parser for AST nodes)
fn test_alloc() -> bool do
    let size :: u64 = 64
    let mem_ptr :: ptr<u8> = alloc(size)
    let null_ptr :: ptr<u8> = 0
    if mem_ptr == null_ptr do
        ret false
    end
    dealloc(mem_ptr)
    ret true
end

-- Test pointer arithmetic (used for node traversal)
fn test_ptr_add() -> bool do
    let base :: ptr<u8> = alloc(16)
    let offset :: ptr<u8> = ptr_add(base, 8)

    -- Store and load test
    store_i64(base, 42)
    store_i64(offset, 100)

    let v1 :: i64 = load_i64(base)
    let v2 :: i64 = load_i64(offset)

    dealloc(base)

    if v1 != 42 do
        ret false
    end
    if v2 != 100 do
        ret false
    end
    ret true
end

-- Test store/load operations (used for AST node fields)
fn test_store_load() -> bool do
    let mem_ptr :: ptr<u8> = alloc(8)

    store_i64(mem_ptr, 12345)
    let val :: i64 = load_i64(mem_ptr)

    dealloc(mem_ptr)

    if val != 12345 do
        ret false
    end
    ret true
end

-- Test string comparison (used for keyword matching)
fn test_keyword_match() -> bool do
    if str_eq("fn", "fn") == false do
        ret false
    end
    if str_eq("let", "let") == false do
        ret false
    end
    if str_eq("fn", "let") == true do
        ret false
    end
    ret true
end

-- Test memory zeroing (used for node initialization)
fn test_mem_zero() -> bool do
    let size :: u64 = 16
    let mem_ptr :: ptr<u8> = alloc(size)

    -- Set some values
    store_i64(mem_ptr, 999)

    -- Zero the memory
    mem_zero(mem_ptr, size)

    -- Check it's zero
    let val :: i64 = load_i64(mem_ptr)
    dealloc(mem_ptr)

    if val != 0 do
        ret false
    end
    ret true
end

fn main() -> i32 do
    io_print("=== Parser Tests ===")

    mut passed :: i64 = 0
    mut failed :: i64 = 0

    if test_alloc() do
        io_print("test_alloc: PASS")
        passed = passed + 1
    else do
        io_print("test_alloc: FAIL")
        failed = failed + 1
    end

    if test_ptr_add() do
        io_print("test_ptr_add: PASS")
        passed = passed + 1
    else do
        io_print("test_ptr_add: FAIL")
        failed = failed + 1
    end

    if test_store_load() do
        io_print("test_store_load: PASS")
        passed = passed + 1
    else do
        io_print("test_store_load: FAIL")
        failed = failed + 1
    end

    if test_keyword_match() do
        io_print("test_keyword_match: PASS")
        passed = passed + 1
    else do
        io_print("test_keyword_match: FAIL")
        failed = failed + 1
    end

    if test_mem_zero() do
        io_print("test_mem_zero: PASS")
        passed = passed + 1
    else do
        io_print("test_mem_zero: FAIL")
        failed = failed + 1
    end

    io_print("=== Parser Tests Complete ===")
    if failed == 0 do
        ret 0
    end
    ret 1
end
