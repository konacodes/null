-- nullc/tests/codegen_test.null
-- Tests for the self-hosted codegen

@use "std/io.null"
@use "std/mem.null"
@use "std/string.null"
@use "nullc/src/codegen.null"

fn test_codegen_new() -> bool do
    let cg :: Codegen = codegen_new()

    -- Check initial state
    if cg.temp_counter != 0 do
        io_print("FAIL: temp_counter should start at 0")
        ret false
    end

    if cg.label_counter != 0 do
        io_print("FAIL: label_counter should start at 0")
        ret false
    end

    ret true
end

fn test_emit_module_header() -> bool do
    mut cg :: Codegen = codegen_new()
    cg = emit_module_header(cg)

    -- Check that output buffer has content
    if cg.output.len == 0 do
        io_print("FAIL: module header should produce output")
        ret false
    end

    ret true
end

fn test_emit_fn_start() -> bool do
    mut cg :: Codegen = codegen_new()
    cg = emit_fn_start(cg, "test_fn", "i32")

    if cg.output.len == 0 do
        io_print("FAIL: fn_start should produce output")
        ret false
    end

    ret true
end

fn test_emit_ret() -> bool do
    mut cg :: Codegen = codegen_new()
    cg = emit_ret(cg, "i32", 0)

    if cg.output.len == 0 do
        io_print("FAIL: ret should produce output")
        ret false
    end

    ret true
end

fn test_temp_counter() -> bool do
    mut cg :: Codegen = codegen_new()

    let t1 :: i64 = next_temp(cg)
    if t1 != 0 do
        io_print("FAIL: first temp should be 0")
        ret false
    end

    cg = inc_temp(cg)
    let t2 :: i64 = next_temp(cg)
    if t2 != 1 do
        io_print("FAIL: second temp should be 1")
        ret false
    end

    ret true
end

fn test_label_counter() -> bool do
    mut cg :: Codegen = codegen_new()

    let l1 :: i64 = next_label(cg)
    if l1 != 0 do
        io_print("FAIL: first label should be 0")
        ret false
    end

    cg = inc_label(cg)
    let l2 :: i64 = next_label(cg)
    if l2 != 1 do
        io_print("FAIL: second label should be 1")
        ret false
    end

    ret true
end

fn main() -> i32 do
    io_print("=== Codegen Tests ===")

    mut passed :: i64 = 0
    mut failed :: i64 = 0

    if test_codegen_new() do
        io_print("test_codegen_new: PASS")
        passed = passed + 1
    else do
        io_print("test_codegen_new: FAIL")
        failed = failed + 1
    end

    if test_emit_module_header() do
        io_print("test_emit_module_header: PASS")
        passed = passed + 1
    else do
        io_print("test_emit_module_header: FAIL")
        failed = failed + 1
    end

    if test_emit_fn_start() do
        io_print("test_emit_fn_start: PASS")
        passed = passed + 1
    else do
        io_print("test_emit_fn_start: FAIL")
        failed = failed + 1
    end

    if test_emit_ret() do
        io_print("test_emit_ret: PASS")
        passed = passed + 1
    else do
        io_print("test_emit_ret: FAIL")
        failed = failed + 1
    end

    if test_temp_counter() do
        io_print("test_temp_counter: PASS")
        passed = passed + 1
    else do
        io_print("test_temp_counter: FAIL")
        failed = failed + 1
    end

    if test_label_counter() do
        io_print("test_label_counter: PASS")
        passed = passed + 1
    else do
        io_print("test_label_counter: FAIL")
        failed = failed + 1
    end

    io_print("=== Results ===")
    if failed == 0 do
        io_print("All codegen tests passed!")
        ret 0
    else do
        io_print("Some tests failed")
        ret 1
    end
end
