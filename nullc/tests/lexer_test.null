-- nullc/tests/lexer_test.null
-- Tests for the self-hosted lexer

@use "std/io.null"
@use "std/mem.null"
@use "std/string.null"
@use "nullc/src/lexer.null"

fn test_single_tokens() -> bool do
    -- Test single character tokens
    let src :: ptr<u8> = "+-*/"
    let len :: i64 = 4
    mut lex :: Lexer = lexer_new(src, len)

    let r1 :: ScanResult = scan_token(lex)
    lex = r1.lex
    if r1.tok.tok_type != 59 do  -- TOK_PLUS
        io_print("FAIL: expected TOK_PLUS")
        ret false
    end

    let r2 :: ScanResult = scan_token(lex)
    lex = r2.lex
    if r2.tok.tok_type != 60 do  -- TOK_MINUS
        io_print("FAIL: expected TOK_MINUS")
        ret false
    end

    let r3 :: ScanResult = scan_token(lex)
    lex = r3.lex
    if r3.tok.tok_type != 61 do  -- TOK_STAR
        io_print("FAIL: expected TOK_STAR")
        ret false
    end

    let r4 :: ScanResult = scan_token(lex)
    lex = r4.lex
    if r4.tok.tok_type != 62 do  -- TOK_SLASH
        io_print("FAIL: expected TOK_SLASH")
        ret false
    end

    ret true
end

fn test_keywords() -> bool do
    let src :: ptr<u8> = "fn let mut if else while for ret end do"
    let len :: i64 = 40
    mut lex :: Lexer = lexer_new(src, len)

    -- Test fn keyword
    let r1 :: ScanResult = scan_token(lex)
    lex = r1.lex
    if r1.tok.tok_type != 4 do  -- TOK_FN
        io_print("FAIL: expected TOK_FN")
        ret false
    end

    -- Test let keyword
    let r2 :: ScanResult = scan_token(lex)
    lex = r2.lex
    if r2.tok.tok_type != 5 do  -- TOK_LET
        io_print("FAIL: expected TOK_LET")
        ret false
    end

    ret true
end

fn test_numbers() -> bool do
    let src :: ptr<u8> = "42 123 0"
    let len :: i64 = 8
    mut lex :: Lexer = lexer_new(src, len)

    let r1 :: ScanResult = scan_token(lex)
    lex = r1.lex
    if r1.tok.tok_type != 0 do  -- TOK_INT_LIT
        io_print("FAIL: expected TOK_INT_LIT")
        ret false
    end
    if r1.tok.int_value != 42 do
        io_print("FAIL: expected int_value 42")
        ret false
    end

    ret true
end

fn test_strings() -> bool do
    let src :: ptr<u8> = "\"hello\""
    let len :: i64 = 7
    mut lex :: Lexer = lexer_new(src, len)

    let r1 :: ScanResult = scan_token(lex)
    if r1.tok.tok_type != 2 do  -- TOK_STRING_LIT
        io_print("FAIL: expected TOK_STRING_LIT")
        ret false
    end

    ret true
end

fn test_identifiers() -> bool do
    let src :: ptr<u8> = "foo bar_baz x123"
    let len :: i64 = 16
    mut lex :: Lexer = lexer_new(src, len)

    let r1 :: ScanResult = scan_token(lex)
    lex = r1.lex
    if r1.tok.tok_type != 3 do  -- TOK_IDENT
        io_print("FAIL: expected TOK_IDENT for 'foo'")
        ret false
    end

    let r2 :: ScanResult = scan_token(lex)
    lex = r2.lex
    if r2.tok.tok_type != 3 do  -- TOK_IDENT
        io_print("FAIL: expected TOK_IDENT for 'bar_baz'")
        ret false
    end

    ret true
end

fn main() -> i32 do
    io_print("=== Lexer Tests ===")

    mut passed :: i64 = 0
    mut failed :: i64 = 0

    if test_single_tokens() do
        io_print("test_single_tokens: PASS")
        passed = passed + 1
    else do
        io_print("test_single_tokens: FAIL")
        failed = failed + 1
    end

    if test_keywords() do
        io_print("test_keywords: PASS")
        passed = passed + 1
    else do
        io_print("test_keywords: FAIL")
        failed = failed + 1
    end

    if test_numbers() do
        io_print("test_numbers: PASS")
        passed = passed + 1
    else do
        io_print("test_numbers: FAIL")
        failed = failed + 1
    end

    if test_strings() do
        io_print("test_strings: PASS")
        passed = passed + 1
    else do
        io_print("test_strings: FAIL")
        failed = failed + 1
    end

    if test_identifiers() do
        io_print("test_identifiers: PASS")
        passed = passed + 1
    else do
        io_print("test_identifiers: FAIL")
        failed = failed + 1
    end

    io_print("=== Results ===")
    if failed == 0 do
        io_print("All lexer tests passed!")
        ret 0
    else do
        io_print("Some tests failed")
        ret 1
    end
end
