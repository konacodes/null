-- nullc/main.null
-- Self-hosted null compiler - minimal AST-driven version
-- Note: Uses hardcoded name "main" due to compiler bug with
-- loading names inside while loops

@use "std/io.null"
@use "std/mem.null"
@use "std/string.null"
@use "std/file.null"
@use "nullc/parser.null"
@use "nullc/codegen.null"

fn codegen_ast(cg :: Codegen, np :: ptr<u8>) -> Codegen do
    cg = emit_module_header(cg)

    let count :: i64 = load_i64(ptr_add(np, 168))
    let data :: ptr<u8> = load_ptr(ptr_add(np, 160))

    -- Walk declarations and emit stub functions
    -- Note: Uses hardcoded "main" name due to compiler bug
    let i :: i64 = 0
    while i < count do
        let decl :: ptr<u8> = load_ptr(ptr_add(data, i * 8))
        cg = emit_fn_start(cg, "main", "i32")
        cg = emit_ret(cg, "i32", 0)
        cg = emit_fn_end(cg)
        i = i + 1
    end

    ret cg
end

fn do_codegen(ast :: ptr<u8>) -> i32 do
    print("Generating IR...")
    println()
    let cg :: Codegen = codegen_new()
    cg = codegen_ast(cg, ast)

    let ir_path :: ptr<u8> = "/tmp/claude/nullc_out.ll"
    let f :: ptr<u8> = file_open_write(ir_path)
    let out :: StringBuf = cg.output
    file_write(f, out.data, out.len)
    file_close(f)
    print("Written to ")
    print(ir_path)
    println()

    ret 0
end

fn do_parse(source :: ptr<u8>, size :: i64) -> ptr<u8> do
    print("Parsing...")
    println()

    let p :: Parser = parser_new(source, size)
    let result :: ParseResult = parse_program(p)
    p = result.p
    if p.had_error do
        print("Parse ERROR")
        println()
        let np :: ptr<u8> = 0
        ret np
    end
    print("Parse OK")
    println()

    ret result.node
end

fn main() -> i32 do
    print("=== nullc Compiler ===")
    println()

    let source :: ptr<u8> = file_read_all("/tmp/claude/test.null")
    let null_ptr :: ptr<u8> = 0
    if source == null_ptr do
        print("Failed to read")
        println()
        ret 1
    end

    let f :: ptr<u8> = file_open_read("/tmp/claude/test.null")
    let size :: i64 = file_size(f)
    file_close(f)
    print("Read ")
    print_int(size)
    print(" bytes")
    println()

    let ast :: ptr<u8> = do_parse(source, size)
    if ast == null_ptr do
        ret 1
    end

    let result :: i32 = do_codegen(ast)
    let zero :: i32 = 0
    if result != zero do
        ret result
    end

    print("=== Done ===")
    println()
    ret 0
end
